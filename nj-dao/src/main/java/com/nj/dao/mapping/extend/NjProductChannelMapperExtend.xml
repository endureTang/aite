<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nj.dao.extend.NjProductChannelMapperExtend">
    <resultMap id="BaseResultMap" type="com.nj.model.generate.NjProductChannel">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Feb 15 14:14:51 CST 2017.
        -->
        <id column="id" jdbcType="VARCHAR" property="id"/>
        <result column="product_id" jdbcType="VARCHAR" property="productId"/>
        <result column="channel_code" jdbcType="VARCHAR" property="channelCode"/>
        <result column="channel_name" jdbcType="VARCHAR" property="channelName"/>
        <result column="channel_mobile" jdbcType="VARCHAR" property="channelMobile"/>
        <result column="channel_acct" jdbcType="VARCHAR" property="channelAcct"/>
        <result column="channel_type" jdbcType="INTEGER" property="channelType"/>
        <result column="monthly_rate" jdbcType="DOUBLE" property="monthlyRate"/>
        <result column="account_type" jdbcType="INTEGER" property="accountType"/>
        <result column="revenue_rate" jdbcType="DOUBLE" property="revenueRate"/>
        <result column="operate_fee_type" jdbcType="INTEGER" property="operateFeeType"/>
        <result column="operate_fee" jdbcType="REAL" property="operateFee"/>
        <result column="del_flag" jdbcType="BIT" property="delFlag"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="create_by" jdbcType="VARCHAR" property="createBy"/>
        <result column="update_date" jdbcType="TIMESTAMP" property="updateDate"/>
        <result column="update_by" jdbcType="VARCHAR" property="updateBy"/>
    </resultMap>


    <update id="delete" parameterType="String">
		update nj_product_channel set
		del_flag = 1
		where 1=1
		and id = #{id}
	</update>

    <update id="bindChannel" parameterType="PageData">
		update nj_product_channel set
		channel_acct = #{channelAcct},
		channel_open_id = #{channelOpenId}
		where 1=1
		and id = #{channelId}
	</update>

    <select id="getChannelInfoById" parameterType="java.util.Map"
            resultType="java.util.HashMap">
		select c.id,c.product_id as productId,c.channel_name as channelName,c.channel_code as channelCode,c.channel_acct as acct from
		nj_product_channel c
		where 
		c.del_flag = 0
		and c.id = #{channelId}
		and c.product_id = #{productId}
	</select>

    <select id="getChannelList" parameterType="java.util.Map"
            resultType="java.util.HashMap">
		select c.id,c.product_id as productId,c.channel_name as channelName,c.channel_code as channelCode,c.channel_acct as acct from
		nj_product_channel c
		where 
		c.del_flag = 0
		and c.product_id = #{productId}
		order by c.channel_code
	</select>


    <select id="getAllChannelsByProdId" parameterType="java.lang.String"
            resultType="java.util.HashMap">
		SELECT njpc.id AS id, njpc.channel_code AS channelCode, njpc.channel_name AS channelName, njpc.channel_mobile AS channelMobile 
		FROM nj_product_channel njpc 
		WHERE njpc.del_flag=0 AND njpc.product_id=#{productId, jdbcType=VARCHAR}
	</select>

    <select id="getChannelMapByAgentId" parameterType="java.lang.String"
            resultType="java.util.HashMap">
		SELECT njpc.id AS channelId
			,njpc.channel_code AS channelCode
			,njpc.channel_name AS channelName
			,njpc.channel_id AS channelNo
		FROM nj_channel_relative njcr
		INNER JOIN nj_product_channel njpc ON njcr.channel_id = njpc.id
		WHERE njcr.id =#{agentId, jdbcType=VARCHAR}
	</select>

    <select id="getChannelMapBySubId" parameterType="java.lang.String"
            resultType="java.util.HashMap">
		SELECT njpc.id AS channelId
			,njpc.channel_code AS channelCode
			,njpc.channel_name AS channelName
			,njpc.channel_id AS channelNo
		FROM nj_channel_relative njcr
		INNER JOIN nj_product_channel njpc ON njcr.channel_id = njpc.id
		WHERE njcr.id =#{subChannelId, jdbcType=VARCHAR}		
	</select>

    <select id="getOutProductChannelId" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT 
		    t2.id
		FROM
		    nj_product t1
		        LEFT JOIN
		    nj_product_channel t2 ON t2.nj_channel_id = t1.product_threechannel_id
		WHERE
		    t2.del_flag != 1
		        AND t1.product_code = #{productCode, jdbcType=VARCHAR}
	</select>

    <!-- 根据传入相关条件删除 -->
    <delete id="deleteByCondition" parameterType="java.util.Map">
	  	update nj_product_channel set del_flag = 1 where product_id = #{productId}
	  </delete>

    <!-- 根据产品ID获取渠道列表 -->
    <select id="selectByProduct" resultType="java.util.Map">
	  	SELECT
			nj_channel_id as id,
			type as type,
			channel_name as channelName,
			channel_type as channelType,
			operate_fee_type as feeType,
			operate_fee as feeValue,
			bond_type as bondType,
			bond_value as bondValue
		FROM
			nj_product_channel
		WHERE
			del_flag = 0 and 
			product_id = #{productId}
			and type = #{type}
	  </select>
    <!-- 根据产品ID获取渠道列表 -->
    <select id="selectByChannelId" resultType="java.util.Map">
	   SELECT
			a.operate_fee_type AS feeType,
			a.operate_fee AS feeValue,
			a.bond_type AS bondType,
			a.bond_value AS bondValue,
			c.tfcf_id AS collecterId
		FROM
			nj_product_channel a
		INNER JOIN nj_channel b ON a.nj_channel_id = b.id
		INNER JOIN nj_channel_tfcf_act c ON b.repee_account_id = c.id
		WHERE
		a.id = #{channelId}
		AND product_id = #{productId}
	  </select>

    <select id="getChannelByChannelCodeAndProductId" resultType="com.nj.model.generate.NjProductChannel">
	  	SELECT
	  		id,
			nj_channel_id as channel_id,
			operate_fee,
			operate_fee_type
		FROM
			nj_product_channel
		WHERE
			del_flag = 0
		AND	
			channel_type = 1
		AND 
			channel_code = #{channelCode}
		AND 
			product_id = #{productId}
	  </select>


    <select id="getChannelByProductCode" parameterType="java.lang.String" resultType="java.lang.String">
	select npc.id from nj_product np
	INNER JOIN nj_product_channel npc on npc.product_id=np.id and npc.del_flag=0
	INNER JOIN nj_channel nc on nc.id=npc.nj_channel_id
	where np.product_code=  #{productCode} and np.del_flag=0 and npc.channel_type=2
	</select>
	
	<select id="getRepayUserIdByChannelId" resultType="java.lang.String">
		SELECT
			a.tfcf_id
		FROM
			nj_channel_tfcf_act a
		INNER JOIN nj_channel b ON a.id = b.repay_account_id
		INNER JOIN nj_product_channel c ON b.id = c.nj_channel_id
		AND c.id = #{channelId}
	</select>
	
	<select id="getChannelCodeById" resultType="java.util.Map">
		SELECT
			b.`code`
		FROM
			nj_product_channel a
		INNER JOIN nj_channel b ON a.nj_channel_id = b.id
		WHERE
			a.id = #{channelId}
	</select>
</mapper>