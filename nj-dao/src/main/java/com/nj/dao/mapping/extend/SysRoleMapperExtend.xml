<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nj.dao.extend.SysRoleMapperExtend">

 <resultMap id="BaseResultMap" type="com.nj.model.generate.SysRole">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Feb 15 14:14:51 CST 2017.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="office_id" jdbcType="VARCHAR" property="officeId" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="enname" jdbcType="VARCHAR" property="enname" />
    <result column="role_type" jdbcType="VARCHAR" property="roleType" />
    <result column="data_scope" jdbcType="CHAR" property="dataScope" />
    <result column="is_sys" jdbcType="VARCHAR" property="isSys" />
    <result column="useable" jdbcType="VARCHAR" property="useable" />
    <result column="create_by" jdbcType="VARCHAR" property="createBy" />
    <result column="create_date" jdbcType="TIMESTAMP" property="createDate" />
    <result column="update_by" jdbcType="VARCHAR" property="updateBy" />
    <result column="update_date" jdbcType="TIMESTAMP" property="updateDate" />
    <result column="remarks" jdbcType="VARCHAR" property="remarks" />
    <result column="del_flag" jdbcType="BIT" property="delFlag" />
  </resultMap>
  
	<select id="findRolesIdByUserId" resultType="String">
		select distinct r.id
		from sys_role r, sys_user_role ur, sys_user u
		where r.id
		= ur.role_id
		and ur.user_id = u.id
		and u.id=#{userId}
	</select>

	<select id="findNjUserRolesByUserId" resultType="java.util.HashMap">
		select sur.user_id userId,sr.name,sr.id, sur.id as uId, sr.remarks from  sys_user_role sur 
		inner join sys_role sr 
		on  sr.id = sur.role_id
		<if test="userId != null">
			and sur.user_id = #{userId,jdbcType=VARCHAR}
		</if>
		<if test="coporateId != null">
			and sur.coporate_id = #{coporateId,jdbcType=VARCHAR}
		</if>
	</select>
	
	<select id="findNjUserProdRolesByUserId" resultType="java.util.HashMap">
		select ui.userId,ui.productName,group_concat(ui.name separator ',') as roles
		from (
			select 
				sur.user_id as userId,sr.name,np.product_name as productName 
			from  
				sys_user_role sur 
			inner join 
				sys_role sr 
			on  
				sr.id = sur.role_id
			<if test="userId != null">
				and sur.user_id = #{userId,jdbcType=VARCHAR}
			</if>
			<if test="coporateId != null">
				and sur.coporate_id = #{coporateId,jdbcType=VARCHAR}
			</if>
			inner join 
				nj_product_user npu 
			on 
				npu.role_id=sur.role_id 
			<if test="userId != null">
				and npu.user_id = #{userId,jdbcType=VARCHAR}
			</if>
			inner join 
				nj_product np 
			on 
				npu.product_id = np.id and np.del_flag = false
		) ui
		group by ui.userId,ui.productName

	</select>
	
	<select id="findNjUserFlowsRolesByUserId" resultType="java.util.HashMap">
		select ui.userId,ui.productName,group_concat(ui.name separator ',') as roles
		from (
		select pru.user_id as userId,np.product_name as productName ,pr.name from process_role_user pru INNER JOIN process_role pr
			on (pru.process_role_id = pr.id
			<if test="userId != null">
				and pru.user_id = #{userId,jdbcType=VARCHAR}
			</if>
			)
			INNER JOIN process p on (
			p.id = pru.process_id
		) INNER JOIN nj_corp_prod ncp on(
			ncp.product_id = p.product_id
			<if test="coporateId != null">
				and ncp.corporate_id = #{coporateId,jdbcType=VARCHAR}
			</if>
		) INNER JOIN nj_product np ON np.id = ncp.product_id
		) ui
		group by ui.userId,ui.productName
	</select>

	<select id="findAssignableRolesByUserId" resultMap="BaseResultMap">
		select sr.id, sr.name,sr.remarks,sr.role_type from sys_role sr
			where IFNULL(sr.role_type,'') not in ('cadmin','assignment') and sr.id not in (
				select role_id from sys_user_role sur where 1=1 
				<if test="userId != null">
					and sur.user_id = #{userId,jdbcType=VARCHAR}
				</if>
		)

	</select>
	
	<select id="selectResourceByRoleId" parameterType="String" resultType="com.nj.model.generate.SysResource">
		select rs.* from sys_resource as rs 
		INNER JOIN sys_role_resource as rr on rs.id=rr.menu_id
		where rr.role_id=#{roleId}
	</select>
	<update id="delete" parameterType="String">
		update sys_role set
		del_flag = 1
		where 1=1
		and id = #{id}
	</update>

	<update id="batchDelete" parameterType="PageData">
		update sys_role set
		del_flag = 1
		where 1=1
		and id in
		<foreach item="id" collection="idList" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</update>
	
	<!-- 获取所有角色列表 -->
	<select id="selectAllRoleList" parameterType="java.util.Map" resultType="com.nj.model.generate.SysRole">
		SELECT id,name FROM sys_role where del_flag = 0 
		<if test="type != null and type != ''">
			and type = #{type}
		</if>
		order by create_date asc
	</select>
	
	<!-- 获取所有角色列表 -->
	<select id="selectUserHasRoleList" parameterType="java.util.Map" resultType="com.nj.model.generate.SysRole">
		SELECT
			role.id,
			role.name
		FROM
			sys_user_role ur
		LEFT JOIN sys_role role ON ur.role_id = role.id
		WHERE
			del_flag = 0 and
			ur.user_id = #{userId}
			and role.type = #{type}
		order by create_date asc
	</select>
	
	<select id="getUserByRoleTypeCoporateId" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT 
			u.id id,
			u.user_name userName 
		FROM 
			sys_role r
		INNER JOIN 
			sys_user_role ur
		ON 
			r.id = ur.role_id
			AND r.role_type=#{roleType,jdbcType=VARCHAR}
			AND r.office_id=#{coporateId,jdbcType=VARCHAR}
		LEFT JOIN 
			nj_user_info u
		ON 
			ur.user_id = u.id
		order by u.id
	</select>
	
	<!-- 根据用户ID获取角色类型 -->
	<select id="selectRoleByUserId" resultType="java.lang.String">
		SELECT
			GROUP_CONCAT(DISTINCT sys_role.role_type) AS roleType
		FROM
			sys_user_role
		INNER JOIN sys_role ON sys_user_role.role_id = sys_role.id
		WHERE
			user_id = #{userId}
	</select>
	
	<!--根据用户企业ID获得该企业各角色拥有的权限-->
	<select id="selectResourceByCoporateId" resultType="java.util.Map">
	
	
		select  r.office_id  as  officeId,r.id  as  roleId, srr.menu_id as  menuId from  sys_role r
		RIGHT  join  sys_role_resource  srr  on  srr.role_id =  r.id
		where  r.office_id=#{coporateId}
		
	</select>
	
	
		<!-- 获取所有角色列表 -->
	<select id="selectRoleByUserIdFresh" parameterType="java.util.Map" resultType="com.nj.model.generate.SysRole">
		select  sr.*  from    sys_user_role   sur  
		inner  join  sys_role  sr  on  sr.office_id = sur.coporate_id    and     sr.id=sur.role_id    and  sr.del_flag=0
		where  sur.user_id=#{userId}  
	</select>
</mapper>